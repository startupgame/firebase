---
format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: react-native
trigger_map:
- push_branch: "*"
  workflow: primary
- pull_request_source_branch: "*"
  workflow: primary
workflows:
  primary:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@6: {}
    - cache-pull@2: {}
    - npm@1:
        inputs:
        - command: install
        - args: --legacy-peer-deps
    - file-downloader@1:
        inputs:
        - destination: "/android/local.properties"
        - source: |
            sdk.dir=/Users/pal/Library/Android/sdk
    - install-missing-android-tools@3:
        inputs:
        - gradlew_path: "/android/gradlew"
    - script@1:
        title: Configure Java and Android properties
        inputs:
        - content: |
            #!/bin/bash
            echo "Setting up Android build environment..."
            # Update gradle.properties to avoid toolchain issues
            cat > /android/gradle.properties <<EOF
            org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
            android.useAndroidX=true
            android.enableJetifier=true
            org.gradle.daemon=false
            org.gradle.java.installations.auto-detect=false
            org.gradle.toolchains.foojay-resolver-convention.enabled=false
            react.internal.disableJavaVersionAlignment=true
            EOF
            echo "Environment configured"
    - android-build@1:
        title: "Build Android APK"
        inputs:
        - project_location: "/android"
        - module: app
        - variant: release
        - build_type: apk
    - deploy-to-bitrise-io@2:
        inputs:
        - deploy_path: "/android/app/build/outputs/apk/release/app-release.apk"
    - cache-push@2: {}
app:
  envs:
  - opts:
      is_expand: false
    GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.java.installations.auto-detect=false -Dorg.gradle.toolchains.foojay-resolver-convention.enabled=false"
